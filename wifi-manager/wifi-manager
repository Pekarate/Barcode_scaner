#!/usr/bin/python3
import os
import subprocess
import json
import time
import requests

def run_device_command(cmd):
    cmd = cmd.strip().split()
    result = subprocess.run(cmd, capture_output=True, text=True)
    return result.stdout if result.returncode == 0 else result.stderr

json_file = "/etc/cfg.json"

with open(json_file) as file:
    data_cfg = json.load(file)

ssid = data_cfg['ssid']
password = data_cfg['password']
host_name = data_cfg['host']
port = data_cfg['port']
device_id = data_cfg['device_id']
desktop_url = f'http://{host_name}:{port}/device_register'
register_flag = False


while True:
    out = run_device_command(f'iwgetid')
    print(out)
    if ssid not in out:
        if os.path.exists('/etc/wifi_connected'):
            os.remove('/etc/wifi_connected')
        print(os.system(f'nmcli d wifi connect "{ssid}" password "{password}"'))
        time.sleep(2)
    else:
        os.system('touch /etc/wifi_connected')
        response = requests.post(desktop_url, json={'device_id': device_id})
        time.sleep(50)
